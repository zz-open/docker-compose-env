include .env
include ../../../conf/mk/common.mk

CONTAINERS=${MYSQL_CLUSTER_MANAGEMENT_CONTAINER_NAME} ${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE1} ${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE2} ${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE3} ${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE4} ${MYSQL_CLUSTER_SQL_HOSTNAME_NODE1} ${MYSQL_CLUSTER_SQL_HOSTNAME_NODE2}

.PHONY: help test
help:
	@echo "usage: make <option>"
	@echo "options and effects:"
	@echo "    help                     : Show help"
	@echo "    test                     : Test ..."
	@echo "    build                    : build"
	@echo "    start                    : 启动所有服务"

test:
	@echo "test ..."

.PHONY: build start reset start_pma
build:
	@${DOCKER_COMPOSE_BUILD} ${CONTAINERS}
reset:
	@${DOCKER_COMPOSE_STOP}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_MANAGEMENT_CONTAINER_NAME}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE1}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE2}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE3}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_DATA_CONTAINER_NAME_NODE4}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_SQL_HOSTNAME_NODE1}
	rm -rf ${DATA_PATH_HOST}/${MYSQL_CLUSTER_SQL_HOSTNAME_NODE2}
	@${DOCKER_COMPOSE_DOWN}

start:
	@${DOCKER_COMPOSE_UP} -d ${CONTAINERS}

start_pma:
	@${DOCKER_COMPOSE_UP} -d ${MYSQL_CLUSTER_PMA_CONTAINER_NAME}

.PHONY: enter-sql1 enter-sql2 pasword
enter-sql1:
	@${DOCKER_COMPOSE_EXEC} ${MYSQL_CLUSTER_SQL_CONTAINER_NAME_NODE1} /bin/sh

enter-sql2:
	@${DOCKER_COMPOSE_EXEC} ${MYSQL_CLUSTER_SQL_CONTAINER_NAME_NODE2} /bin/sh

pasword:
	@${DOCKER_COMPOSE_LOGS} ${MYSQL_CLUSTER_SQL_HOSTNAME_NODE1} | grep "GENERATED ROOT PASSWORD"